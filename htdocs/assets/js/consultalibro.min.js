/* globals $, Config */

/**
 * frontend/consulta-libros/index
 */
$(document).ready(function () {
    'use strict';

    if (typeof filmotecaConfig.consultaLibro === 'undefined') {
        return;
    }

    var alphabet = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","Ñ","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
    var signs = ["¿","¡"];
    var $letterSelector = $('#letter-selector');
    var $books = $('#books > .item');
    var $results = $('#results');
    var $noresults = $('.noresults');
    var $itemsWrapper = $('.wrapper-items');
    var $modal = $('.modal');
    var $modalBody = $modal.find('.modal-content');
    var foundBooks = 0;
    $("span").show(".ui-slider-tip");

    /***********************
     * Slider
     ***********************/

    var filterBooks = function (event, ui) {
        foundBooks = 0;
        $books.each(function (index, book) {
            var $book = $(book);
            var titleFirst = $book.data('title-first');
            var UppertitleFirst = titleFirst.toUpperCase();
            var titleSecond= $book.data('title-second');
            var UppertitleSecond = titleSecond.toUpperCase();

            $("span").remove(".ui-slider-tip");

            /***********************  
             * Función en caso de vocales con acento
            ***********************/

            if (titleFirst == "Á" || titleFirst == "á" || titleSecond == "Á" ||  titleSecond == "á"){
              var UppertitleFirst = "A";
              var UppertitleSecond = "A";
            } else if (titleFirst == "É" || titleFirst == "é" || titleSecond == "É" || titleSecond == "é"){
              var UppertitleFirst = "E";
              var UppertitleSecond = "E";
            } else if (titleFirst == "Í" || titleFirst == "í" || titleSecond == "Í" || titleSecond == "í"){
              var UppertitleFirst = "I";
              var UppertitleSecond = "I";
            } else if (titleFirst == "Ó" || titleFirst == "ó" || titleSecond == "Ó" || titleSecond == "ó"){
              var UppertitleFirst = "O";
              var UppertitleSecond = "O";
            } else if (titleFirst == "Ú" || titleFirst == "ú" || titleSecond == "Ú" || titleSecond == "ú"){
              var UppertitleFirst = "U";
              var UppertitleSecond = "U";
            }
            
            if ( alphabet[ui.value] == UppertitleFirst ) {
                $book.show();
                foundBooks++;
            } 
            else if ( titleFirst == signs[0]  && alphabet[ui.value] == UppertitleSecond || titleFirst == signs[1] && alphabet[ui.value] == UppertitleSecond ) {
                $book.show();
                foundBooks++;
            } else {
                $book.hide();
            }
        });

        $results.children('.number').html(foundBooks);
          if ( foundBooks == 0) {
            $noresults.show();
          } else {
            $noresults.hide();
          }
        
    };

    // // Events
    // // The user move the nuts of the letters
    $letterSelector.on('slidechange', filterBooks);

    // Initializes the default status
    $letterSelector.on('slidecreate', function () {
        filterBooks({}, {value: filmotecaConfig.consultaLibro.slider.value});
    });

    // Initialization of slider
    $letterSelector
        .slider({
            min : filmotecaConfig.consultaLibro.slider.minValue,
            max: filmotecaConfig.consultaLibro.slider.maxValue,
            value: filmotecaConfig.consultaLibro.slider.value,
            animate: true
        })
        .slider('pips',{
            rest: 'label',
            labels: alphabet
        })
        .slider('float', {});


    /**************************
     * Modal
     **************************/
    var bookId;

    $modal.modal({
        show: false
    });

    $modal.on('shown.bs.modal', function () {
        $modalBody.load('/consulta-libro/' + bookId);
    });

    $itemsWrapper.on('click', '.item a', function (event) {
        var $this = $(this);

        bookId = $this.data('id');
        event.preventDefault();
        $modalBody.html('<div class="loading loading-box-md center-block"></div>');
        $modal.modal('show');
    });

    /*****************
     * Autocomple
     ******************/

    $( '#book-searcher' ).autocomplete({
        minLength: 0,
        source: '/consulta-libro',
        select: function(event, ui) {
            bookId = ui.item.id;
            $modalBody.html('<div class="loading loading-box-md center-block"></div>');
            $modal.modal('show');
            return false;
        }
    })
        .autocomplete( 'instance' )._renderItem = function(ul, item) {
        return $('<li>')
            .append(
                '<div><img class="tiny-searchresults" src="' +item.url_image + '">' + item.title + '</div>'
            )
            .appendTo(ul);
    };
});