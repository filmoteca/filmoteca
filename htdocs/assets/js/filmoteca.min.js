/* globals $, Config */


/**
 * frontend/exhibitions/index
 */
$(document).ready(function () {

    'use strict';

    var $exhibitionsIndex = $('.exhibitions.index');
    var moreSchedulesSelector = '.more-schedules';

    $(moreSchedulesSelector).collapse({
        toggle: false
    });
    
    $exhibitionsIndex.on('click', moreSchedulesSelector , function (event) {

        var $element = $(event.target);
        var $collapsible = $element.siblings('.collapse');
        var config = {
            url: $element.data('href'),
            accepts: 'text/html',
            dataType: 'html',
            data: {
                since: $element.data('since')
            }
        };

        //if ($element.data('loaded')) {
           // $collapsible.collapse('toggle'); //esta funci칩n hace que el bot칩n se pueda apretar una y otra vez
            // return;
        //}
      


        $.ajax(config)
            .success(function (response) {
                $collapsible.html(response).collapse('show');

                $element.data('loaded', true);
            })
            .fail(function () {
                $collapsible.collapse('hide');
            })
            .always(function () {
                $element.removeClass('loading');
            });
    });

    $('.more-schedules').trigger('click'); //se agrego un disparador para cargar m치s horarios por default
    $('.more-schedules').addClass('loading');  //se cambi칩 de lugar 
    
    var $filmsSearcher = $('#films-searcher');

    $filmsSearcher.autocomplete({
        minLength: 0,
        source: function(request, response) {
            $.ajax({
                url: Config.routes.exhibitions_frontend_exhibitions_filmssearcher,
                dataType: 'json',
                data: {
                    title: request.term
                },
                success: function(data) {
                    response(data);
                }
            });
        },
        select: function (event, ui) {
            var url = Config.routes.exhibitions_frontend_exhibitions_index;
            var query = 'title=' + ui.item.value;

            window.location = url + '?' + query
        }
    });

    $('#accordion').accordion({
        heightStyle: 'content',
        collapsible : true,
        active: false
    });
});


/**
 * frontend/filmoteca-medals/index
 */
$(document).ready(function () {
    'use strict';

    if (typeof filmotecaConfig.filmotecaMedal === 'undefined') {
        return;
    }

    var MIN_YEAR_INDEX = 0;
    var MAX_YEAR_INDEX = 1;

    var $yearSelector = $('#year-selector');
    var $winners = $('#winners > .item');
    var $results = $('#results');
    var $itemsWrapper = $('.wrapper-items');
    var $modal = $('.modal');
    var $modalBody = $modal.find('.modal-content');
    var foundWinners = 0;

    /***********************
     * Slider
     ***********************/

    var filterWinners = function (event, ui) {
        foundWinners = 0;
        $winners.each(function (index, winner) {
            var $winner = $(winner);
            var awardYear = parseInt($winner.data('award-year'));

            if (awardYear >= ui.values[MIN_YEAR_INDEX] && awardYear <= ui.values[MAX_YEAR_INDEX]) {
                $winner.show();
                foundWinners++;
            } else {
                $winner.hide();
            }
        });

        $results.children('.number').html(foundWinners);
    };

    // // Events
    // // The user move the nuts of the years
    $yearSelector.on('slidechange', filterWinners);

    // Initializes the default status
    $yearSelector.on('slidecreate', function () {
        filterWinners({}, {values: filmotecaConfig.filmotecaMedal.slider.value});
    });

    // Initialization of slider
    $yearSelector
        .slider({
            range: true,
            min : filmotecaConfig.filmotecaMedal.slider.minYear,
            max: filmotecaConfig.filmotecaMedal.slider.maxYear,
            step: 1,
            values: filmotecaConfig.filmotecaMedal.slider.value,
            animate: true
        })
        .slider('pips',{
            rest: 'label',
            step: filmotecaConfig.filmotecaMedal.slider.step
        })
        .slider('float', {});

    /**************************
     * Modal
     **************************/
    var winnerId;

    $modal.modal({
        show: false
    });

    $modal.on('shown.bs.modal', function () {
        $modalBody.load('/filmoteca-medal/' + winnerId);
    });

    $itemsWrapper.on('click', '.item a', function (event) {
        var $this = $(this);

        winnerId = $this.data('id');
        event.preventDefault();
        $modalBody.html('<div class="loading loading-box-md center-block"></div>');
        $modal.modal('show');
    });

    /*****************
     * Autocomple
     ******************/

    $( '#winner-searcher' ).autocomplete({
        minLength: 0,
        source: '/filmoteca-medal',
        select: function(event, ui) {
            winnerId = ui.item.id;
            $modalBody.html('<div class="loading loading-box-md center-block"></div>');
            $modal.modal('show');
            return false;
        }
    })
        .autocomplete( 'instance' )._renderItem = function(ul, item) {
        return $('<li>')
            .append(
                '<div><img src="' +item.url_image + '">' + item.name + '<br>' + item.award_date + '</div>'
            )
            .appendTo(ul);
    };
});
